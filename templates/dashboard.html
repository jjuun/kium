<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-ki Trading Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>A-ki Trading Dashboard</h1>
            <div class="status-indicator">
                <span id="connection-status">🔄 서버 연결 확인 중...</span>
                <div class="controls">
                    <button id="refresh-toggle" class="btn btn-danger">자동 새로고침 끄기</button>
                </div>
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- 계좌 정보 -->
            <div class="card">
                <h3>계좌 정보</h3>
                <div id="balance-content" class="loading">로딩 중...</div>
                <div id="holdings-content" class="loading"></div>
            </div>

            <!-- 주문 실행 -->
            <div class="card">
                <h3>주문 실행</h3>
                <form id="order-form">
                    <div class="form-group">
                        <label for="order-symbol">종목코드:</label>
                        <input type="text" id="order-symbol" placeholder="종목코드" required>
                    </div>
                    <div class="form-group">
                        <label for="order-action">매매구분:</label>
                        <select id="order-action" required>
                            <option value="buy">매수</option>
                            <option value="sell">매도</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="order-quantity">수량:</label>
                        <input type="number" id="order-quantity" placeholder="수량" value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="order-price">가격:</label>
                        <input type="number" id="order-price" placeholder="가격" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="order-price-type">호가구분:</label>
                        <select id="order-price-type" required>
                            <option value="00">지정가</option>
                            <option value="03">시장가</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">주문 실행</button>
                </form>
            </div>

            <!-- 미체결 주문 -->
            <div class="card">
                <h3>미체결 주문</h3>
                <div id="pending-orders-content" class="loading">로딩 중...</div>
            </div>


        </div>

        <!-- 자동매매 제어 섹션 -->
        <div class="card" id="auto-trading-section" style="margin-top: 32px;">
            <h3>자동매매 제어</h3>
            <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 16px; flex-wrap: wrap;">
                <div id="auto-trading-status" style="padding: 8px 16px; border-radius: 4px; background: #f8f9fa;">
                    상태: 확인 중...
                </div>
                <div id="trading-mode-status" style="padding: 8px 16px; border-radius: 4px; border: 2px solid #007bff;">
                    <span id="mode-indicator">🧪 테스트 모드</span>
                </div>
                <!-- 토큰 상태 표시 -->
                <div id="token-status"
                    style="padding: 8px 16px; border-radius: 4px; border: 2px solid #28a745; background: #f8f9fa; cursor: pointer;"
                    onclick="refreshTokenManually()" title="클릭하여 토큰 갱신">
                    <span id="token-indicator">🔑 토큰 확인 중...</span>
                </div>
                <!-- 매매 수량 입력 필드 추가 -->
                <div style="display: flex; gap: 8px; align-items: center;">
                    <label for="trade-quantity" style="margin: 0; font-size: 0.9em;">매매 수량:</label>
                    <input type="number" id="trade-quantity" min="1" value="1"
                        style="width: 80px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <!-- 쿨다운 설정 필드 추가 -->
                <div style="display: flex; gap: 8px; align-items: center;">
                    <label for="cooldown-minutes" style="margin: 0; font-size: 0.9em;">쿨다운 시간:</label>
                    <input type="number" id="cooldown-minutes" min="0" value="1"
                        style="width: 80px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <span style="font-size: 0.9em; color: #666;">분</span>
                    <button id="update-cooldown" class="btn btn-secondary" onclick="updateCooldown()"
                        style="padding: 2px 8px; font-size: 0.8em;">적용</button>
                </div>
                <button id="start-auto-trading" class="btn btn-success" onclick="startAutoTrading()">자동매매 시작</button>
                <button id="stop-auto-trading" class="btn btn-danger" onclick="stopAutoTrading()"
                    style="display: none;">자동매매 중지</button>
                <button id="toggle-trading-mode" class="btn btn-warning" onclick="toggleTradingMode()"
                    title="실제매매/테스트모드 전환">모드 전환</button>
            </div>

            <!-- 자동매매 통계 정보 -->
            <div id="auto-trading-stats" style="margin-bottom: 16px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    <!-- 일일 주문 통계 -->
                    <div
                        style="padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <div style="font-weight: bold; color: #007bff; cursor: pointer;"
                                onclick="showExecutedOrdersDetails()">📊 일일 주문</div>
                            <button onclick="resetDailyOrderCount()" class="btn btn-sm btn-outline-primary"
                                style="padding: 2px 6px; font-size: 0.7em;">초기화</button>
                        </div>
                        <div id="daily-orders" style="font-size: 1.1em;">0/10</div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 4px;">오늘 실행된 주문 수 / 최대 허용 수</div>
                        <div style="font-size: 0.8em; color: #007bff; margin-top: 4px; cursor: pointer;"
                            onclick="showExecutedOrdersDetails()">클릭하여 주문 내역 보기</div>
                    </div>

                    <!-- 감시 종목 통계 -->
                    <div id="watchlist-summary"
                        style="padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #28a745; cursor: pointer;"
                        onclick="showWatchlistDetails()">
                        <div style="font-weight: bold; color: #28a745; margin-bottom: 4px;">👀 감시 종목</div>
                        <div id="watchlist-count" style="font-size: 1.1em;">1개</div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 4px;">클릭하여 상세 보기</div>
                    </div>

                    <!-- 활성 조건 통계 -->
                    <div id="active-conditions-summary"
                        style="padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #ffc107; cursor: pointer;"
                        onclick="showActiveConditionsDetails()">
                        <div style="font-weight: bold; color: #ffc107; margin-bottom: 4px;">⚙️ 활성 조건</div>
                        <div id="active-conditions-count" style="font-size: 1.1em;">5개</div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 4px;">클릭하여 상세 보기</div>
                    </div>
                </div>
            </div>

            <!-- 에러 상황 표시 영역 -->
            <div id="error-alerts" style="margin-bottom: 16px;">
                <!-- 토큰 에러 -->
                <div id="token-error-alert" class="alert alert-danger"
                    style="display: none; margin-bottom: 8px; padding: 10px; border-radius: 4px; border: 1px solid #dc3545; background: #f8d7da; color: #721c24;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>🔑</span>
                        <div>
                            <strong>토큰 에러:</strong>
                            <span id="token-error-message">토큰이 유효하지 않습니다.</span>
                        </div>
                        <button onclick="refreshTokenManually()" class="btn btn-sm btn-outline-danger"
                            style="margin-left: auto;">토큰 갱신</button>
                    </div>
                </div>

                <!-- 장시간 에러 -->
                <div id="market-error-alert" class="alert alert-warning"
                    style="display: none; margin-bottom: 8px; padding: 10px; border-radius: 4px; border: 1px solid #ffc107; background: #fff3cd; color: #856404;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>⏰</span>
                        <div>
                            <strong>장시간 알림:</strong>
                            <span id="market-error-message">현재 장이 종료되었습니다.</span>
                        </div>
                        <button onclick="checkMarketStatus()" class="btn btn-sm btn-outline-warning"
                            style="margin-left: auto;">확인</button>
                    </div>
                </div>

                <!-- 자동매매 에러 -->
                <div id="auto-trading-error-alert" class="alert alert-danger"
                    style="display: none; margin-bottom: 8px; padding: 10px; border-radius: 4px; border: 1px solid #dc3545; background: #f8d7da; color: #721c24;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>🤖</span>
                        <div>
                            <strong>자동매매 에러:</strong>
                            <span id="auto-trading-error-message">자동매매 실행 중 오류가 발생했습니다.</span>
                        </div>
                        <button onclick="hideErrorAlert('auto-trading')" class="btn btn-sm btn-outline-danger"
                            style="margin-left: auto;">닫기</button>
                    </div>
                </div>

                <!-- 일반 에러 -->
                <div id="general-error-alert" class="alert alert-danger"
                    style="display: none; margin-bottom: 8px; padding: 10px; border-radius: 4px; border: 1px solid #dc3545; background: #f8d7da; color: #721c24;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>⚠️</span>
                        <div>
                            <strong>시스템 에러:</strong>
                            <span id="general-error-message">시스템 오류가 발생했습니다.</span>
                        </div>
                        <button onclick="hideErrorAlert('general')" class="btn btn-sm btn-outline-danger"
                            style="margin-left: auto;">닫기</button>
                    </div>
                </div>
            </div>

            <div id="auto-trading-message" style="margin-top: 8px; color: #c00; font-size: 0.95em;"></div>
        </div>

        <!-- 신호 모니터링 섹션 -->
        <div class="card" id="signal-monitoring-section" style="margin-top: 32px;">
            <h3>신호 모니터링</h3>
            <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                <div id="signal-stats"
                    style="padding: 8px 16px; border-radius: 4px; background: #f8f9fa; font-size: 0.9em;">
                    통계 로딩 중...
                </div>
                <button class="btn btn-secondary" onclick="refreshSignalMonitoring()">새로고침</button>
            </div>
            <div style="margin-bottom: 16px;">
                <h5>최근 신호</h5>
                <table id="recent-signals-table" class="table">
                    <thead>
                        <tr>
                            <th>시간</th>
                            <th>종목</th>
                            <th>타입</th>
                            <th>조건</th>
                            <th>신호 당시 가격</th>
                            <th>상태</th>
                            <th>수익/손실</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JS로 동적 렌더링 -->
                    </tbody>
                </table>
            </div>
            <div id="signal-message" style="margin-top: 8px; color: #c00; font-size: 0.95em;"></div>
        </div>

        <!-- 감시 종목 관리 섹션 -->
        <div class="card" id="watchlist-section" style="margin-top: 32px;">
            <h3>감시 종목 관리</h3>
            <form id="watchlist-add-form" style="display: flex; gap: 8px; margin-bottom: 12px;">
                <input type="text" id="watchlist-symbol" placeholder="종목코드" required style="width: 120px;">
                <input type="text" id="watchlist-symbol-name" placeholder="종목명 (자동 입력)" style="width: 180px;" readonly>
                <button type="submit" class="btn btn-primary">추가</button>
            </form>
            <div id="symbol-validation-message" style="margin-bottom: 8px; font-size: 0.9em;"></div>
            <div id="watchlist-stats" style="margin-bottom: 8px; font-size: 0.95em; color: #666;"></div>
            <table id="watchlist-table" class="table">
                <thead>
                    <tr>
                        <th>종목코드</th>
                        <th>종목명</th>
                        <th>상태</th>
                        <th>등록일</th>
                        <th>수정일</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JS로 동적 렌더링 -->
                </tbody>
            </table>
            <div id="watchlist-message" style="margin-top: 8px; color: #c00; font-size: 0.95em;"></div>
        </div>

        <!-- 조건 관리 모달 -->
        <div id="condition-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 id="condition-modal-title">조건 관리</h4>
                    <span class="close" onclick="closeConditionModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- 종목 정보 표시 -->
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h5 id="condition-symbol-info">종목 정보</h5>
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <div>
                                <strong>종목코드:</strong> <span id="condition-symbol-code"></span>
                            </div>
                            <div>
                                <strong>종목명:</strong> <span id="condition-symbol-name"></span>
                            </div>
                        </div>
                    </div>

                    <!-- 새 조건 추가 -->
                    <div style="margin-bottom: 20px;">
                        <h5>새 조건 추가</h5>
                        <form id="condition-add-form" style="display: flex; gap: 8px; align-items: end;">
                            <select id="condition-type" required style="width: 80px;">
                                <option value="buy">매수</option>
                                <option value="sell">매도</option>
                            </select>
                            <select id="condition-category" required style="width: 120px;">
                                <option value="">조건 타입</option>
                                <option value="price">가격 조건</option>
                                <option value="rsi">RSI 조건</option>
                                <option value="ma">이동평균 조건</option>
                                <option value="volume">거래량 조건</option>
                                <option value="volatility">변동성 조건</option>
                                <option value="custom">사용자 정의</option>
                            </select>
                            <input type="text" id="condition-value" placeholder="조건 값 (예: > 50000)" required
                                style="width: 150px;">
                            <input type="text" id="condition-description" placeholder="설명 (선택)" style="width: 180px;">
                            <button type="submit" class="btn btn-primary">추가</button>
                        </form>
                        <div style="margin-top: 8px;">
                            <small class="text-muted">💡 추천 조건:
                                <a href="#" onclick="setConditionTemplate('rsi_oversold')">RSI 과매도 매수</a> |
                                <a href="#" onclick="setConditionTemplate('rsi_overbought')">RSI 과매수 매도</a> |
                                <a href="#" onclick="setConditionTemplate('ma_golden')">이동평균 골든크로스</a> |
                                <a href="#" onclick="setConditionTemplate('volume_surge')">거래량 급증</a>
                            </small>
                        </div>
                    </div>

                    <!-- 등록된 조건 목록 -->
                    <div>
                        <h5>등록된 조건</h5>
                        <table id="condition-table" class="table">
                            <thead>
                                <tr>
                                    <th>타입</th>
                                    <th>카테고리</th>
                                    <th>조건 값</th>
                                    <th>설명</th>
                                    <th>성공률</th>
                                    <th>상태</th>
                                    <th>등록일</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- JS로 동적 렌더링 -->
                            </tbody>
                        </table>
                    </div>
                    <div id="condition-message" style="margin-top: 8px; color: #c00; font-size: 0.95em;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 조건 수정 모달 -->
    <div id="edit-condition-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h4>조건 수정</h4>
                <span class="close" onclick="closeEditConditionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-condition-form">
                    <div class="form-group">
                        <label for="edit-condition-type">타입:</label>
                        <select id="edit-condition-type" disabled style="width: 100%;">
                            <option value="buy">매수</option>
                            <option value="sell">매도</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-condition-category">카테고리:</label>
                        <select id="edit-condition-category" disabled style="width: 100%;">
                            <option value="price">가격 조건</option>
                            <option value="rsi">RSI 조건</option>
                            <option value="ma">이동평균 조건</option>
                            <option value="volume">거래량 조건</option>
                            <option value="volatility">변동성 조건</option>
                            <option value="custom">사용자 정의</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-condition-value">조건 값:</label>
                        <input type="text" id="edit-condition-value" placeholder="조건 값" required style="width: 100%;">
                    </div>
                    <div class="form-group">
                        <label for="edit-condition-description">설명:</label>
                        <input type="text" id="edit-condition-description" placeholder="설명 (선택)" style="width: 100%;">
                    </div>
                    <div class="form-group">
                        <label for="edit-condition-active">활성화:</label>
                        <input type="checkbox" id="edit-condition-active">
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeEditConditionModal()" class="btn btn-secondary">취소</button>
                        <button type="submit" class="btn btn-primary">저장</button>
                    </div>
                </form>
            </div>
            <div id="edit-condition-message" style="margin-top: 8px; color: #c00; font-size: 0.95em;"></div>
        </div>
    </div>

    <!-- 상세 정보 모달: body 맨 끝으로 이동 -->
    <div id="details-modal" class="modal" style="display: none;" onclick="closeDetailsModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h4 id="details-modal-title">상세 정보</h4>
                <span class="close" onclick="closeDetailsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="details-content">
                    <!-- 동적으로 내용이 채워집니다 -->
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/dashboard.js?v=1.3"></script>
</body>

</html>